<script>
        document.addEventListener('DOMContentLoaded', () => {
            const historyTableContainer = document.getElementById('history-table-container');
            const backToHomeButton = document.getElementById('back-to-home-button');
            const searchButton = document.getElementById('search-button');

            // フィルター要素の取得
            const yearFromFilter = document.getElementById('year-from-filter');
            const monthFromFilter = document.getElementById('month-from-filter');
            const yearToFilter = document.getElementById('year-to-filter');
            const monthToFilter = document.getElementById('month-to-filter');
            const userFilter = document.getElementById('user-filter');


            // 1. ダミーデータ (スクロールテスト用)
            const DUMMY_HISTORY_DATA = [
                { id: 1, workerId: 'M1001', recordDate: '2023/11/24', startTime: '10:00', endTime: '10:04', manufacturedCount: 50, defectiveCount: 2 },
                { id: 2, workerId: 'M1002', recordDate: '2023/11/24', startTime: '10:10', endTime: '10:12', manufacturedCount: 15, defectiveCount: 0 },
                { id: 3, workerId: 'M1001', recordDate: '2023/11/23', startTime: '15:30', endTime: '15:42', manufacturedCount: 120, defectiveCount: 1 },
                { id: 4, workerId: 'M1003', recordDate: '2023/11/23', startTime: '20:00', endTime: '20:03', manufacturedCount: 30, defectiveCount: 3 },
                { id: 5, workerId: 'M1002', recordDate: '2023/11/22', startTime: '09:00', endTime: '09:08', manufacturedCount: 80, defectiveCount: 0 },
                { id: 6, workerId: 'M1004', recordDate: '2023/11/22', startTime: '13:00', endTime: '13:05', manufacturedCount: 45, defectiveCount: 4 },
                { id: 7, workerId: 'M1001', recordDate: '2023/10/01', startTime: '10:00', endTime: '10:04', manufacturedCount: 50, defectiveCount: 0 },
                { id: 8, workerId: 'M1002', recordDate: '2024/01/15', startTime: '10:10', endTime: '10:12', manufacturedCount: 15, defectiveCount: 1 },
                { id: 9, workerId: 'M1003', recordDate: '2024/01/20', startTime: '15:30', endTime: '15:42', manufacturedCount: 120, defectiveCount: 0 },
                { id: 10, workerId: 'M1004', recordDate: '2024/02/01', startTime: '11:00', endTime: '11:10', manufacturedCount: 60, defectiveCount: 5 },
                { id: 11, workerId: 'M1001', recordDate: '2024/02/05', startTime: '12:00', endTime: '12:05', manufacturedCount: 75, defectiveCount: 0 },
                { id: 12, workerId: 'M1002', recordDate: '2024/03/10', startTime: '14:30', endTime: '14:45', manufacturedCount: 90, defectiveCount: 1 },
                { id: 13, workerId: 'M1003', recordDate: '2024/03/15', startTime: '16:00', endTime: '16:08', manufacturedCount: 40, defectiveCount: 2 },
                { id: 14, workerId: 'M1004', recordDate: '2024/04/01', startTime: '10:00', endTime: '10:15', manufacturedCount: 150, defectiveCount: 3 },
                { id: 15, workerId: 'M1001', recordDate: '2024/04/10', startTime: '13:00', endTime: '13:20', manufacturedCount: 100, defectiveCount: 0 },
            ];

            // 3. 期間・作業者フィルターのオプションを設定する関数
            function setupFilters() {
                const dates = DUMMY_HISTORY_DATA.map(item => item.recordDate.split('/')[0]); // 年のみ取得
                const uniqueYears = [...new Set(dates)].sort((a, b) => b - a); // 降順ソート
                const years = uniqueYears.filter(y => y.length === 4); // 4桁の年のみ

                // 年のオプションを追加
                years.forEach(year => {
                    yearFromFilter.add(new Option(year, year));
                    yearToFilter.add(new Option(year, year));
                });

                // 月のオプションを追加
                for (let i = 1; i <= 12; i++) {
                    const month = String(i).padStart(2, '0');
                    monthFromFilter.add(new Option(month, month));
                    monthToFilter.add(new Option(month, month));
                }

                // 作業者オプションを追加
                const workerIds = DUMMY_HISTORY_DATA.map(item => item.workerId);
                const uniqueWorkerIds = [...new Set(workerIds)].sort();

                uniqueWorkerIds.forEach(id => {
                    userFilter.add(new Option(id, id));
                });
            }

            // 4. データをフィルタリングする関数
            function filterHistoryData() {
                // フィルター値の取得
                const filterYearFrom = yearFromFilter.value;
                const filterMonthFrom = monthFromFilter.value;
                const filterYearTo = yearToFilter.value;
                const filterMonthTo = monthToFilter.value;
                const filterUser = userFilter.value;

                // 期間の開始日と終了日を YYYYMM 形式で設定（フィルタリングしやすくするため）
                let dateFrom = '000000';
                if (filterYearFrom && filterMonthFrom) {
                    dateFrom = filterYearFrom + filterMonthFrom;
                }
                
                let dateTo = '999999';
                if (filterYearTo && filterMonthTo) {
                    dateTo = filterYearTo + filterMonthTo;
                }

                const filteredData = DUMMY_HISTORY_DATA.filter(item => {
                    // 1. 作業者IDによるフィルタリング
                    const userMatch = !filterUser || item.workerId === filterUser;

                    // 2. 期間によるフィルタリング
                    const itemDateParts = item.recordDate.split('/');
                    const itemDateYM = itemDateParts[0] + itemDateParts[1];

                    const dateMatch = itemDateYM >= dateFrom && itemDateYM <= dateTo;

                    return userMatch && dateMatch;
                });

                // フィルタリングされたデータでテーブルを再描画
                renderHistoryTable(filteredData);
            }

            // 5. テーブルレンダリング関数
            function renderHistoryTable(data) {
                historyTableContainer.innerHTML = ''; // コンテナをクリア
                
                if (data.length === 0) {
                    historyTableContainer.innerHTML = '<p class="text-center text-gray-500 py-10">該当する履歴データがありません。</p>';
                    return;
                }

                const table = document.createElement('table');
                table.classList.add('min-w-full', 'divide-y', 'divide-gray-200', 'text-sm');
                
                // ヘッダー: 項目名を短縮
                table.innerHTML = `
                    <thead class="bg-gray-50 sticky top-0 z-30 border-b-2 border-gray-200">
                        <tr>
                            <th class="px-1 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">作業者ID</th>
                            <th class="px-1 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日時</th>
                            <th class="px-1 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">開始</th>
                            <th class="px-1 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">終了</th>
                            <th class="px-1 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">製造</th>
                            <th class="px-1 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">不良</th>
                            <th class="px-1 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">不良率</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${data.map((item, index) => {
                            // 不良率の計算
                            const defectRate = item.manufacturedCount > 0 
                                ? ((item.defectiveCount / item.manufacturedCount) * 100).toFixed(1) 
                                : '0.0';

                            return `
                                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50 transition duration-150">
                                    <td class="px-1 py-3 whitespace-nowrap text-gray-900">${item.workerId}</td>
                                    <td class="px-1 py-3 whitespace-nowrap text-gray-900">${item.recordDate}</td>
                                    <td class="px-1 py-3 whitespace-nowrap text-gray-500">${item.startTime}</td>
                                    <td class="px-1 py-3 whitespace-nowrap text-gray-500">${item.endTime}</td>
                                    <td class="px-1 py-3 whitespace-nowrap text-right text-blue-600 font-bold">${item.manufacturedCount}</td>
                                    <td class="px-1 py-3 whitespace-nowrap text-right ${item.defectiveCount > 0 ? 'text-red-600' : 'text-gray-700'} font-bold">${item.defectiveCount}</td>
                                    <td class="px-1 py-3 whitespace-nowrap text-right font-semibold text-gray-700">${defectRate}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                `;

                historyTableContainer.appendChild(table);
            }

            // 6. イベントリスナーの設定
            // 検索ボタンクリックでフィルターを実行
            searchButton.addEventListener('click', filterHistoryData);

            // ホームに戻るボタンのイベント (既存のもの)
            backToHomeButton.addEventListener('click', () => {
                if (typeof electronAPI !== 'undefined' && electronAPI.navigateTo) {
                    electronAPI.navigateTo('index');
                }else{
                    location.href = 'index.html';
                }
            });


            // 初期処理
            setupFilters(); // フィルターオプションを初期設定
            filterHistoryData(); // 初期表示（全てのデータを表示）
        });
    </script>
