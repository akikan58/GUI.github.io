<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100">
    <div class="login-container">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">ログイン</h1>
        <div id="alert-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">エラー:</strong>
            <span class="block sm:inline" id="alert-text"></span>
        </div>
        <div class="input-group">
            <label for="username" class="input-label">ID:</label>
            <input type="text" id="username" class="input-field" placeholder="IDを入力" autofocus>
        </div>
        <div class="input-group">
            <label for="password" class="input-label">パスワード:</label>
            <input type="password" id="password" class="input-field" placeholder="パスワードを入力">
        </div>

        <div class="virtual-keyboard mt-8">
            <div class="keyboard-row">
                <button class="key">1</button>
                <button class="key">2</button>
                <button class="key">3</button>
                <button class="key">4</button>
                <button class="key">5</button>
                <button class="key">6</button>
                <button class="key">7</button>
                <button class="key">8</button>
                <button class="key">9</button>
                <button class="key">0</button>
            </div>
            <div class="keyboard-row">
                <button class="key">q</button>
                <button class="key">w</button>
                <button class="key">e</button>
                <button class="key">r</button>
                <button class="key">t</button>
                <button class="key">y</button>
                <button class="key">u</button>
                <button class="key">i</button>
                <button class="key">o</button>
                <button class="key">p</button>
            </div>
            <div class="keyboard-row">
                <button class="key">a</button>
                <button class="key">s</button>
                <button class="key">d</button>
                <button class="key">f</button>
                <button class="key">g</button>
                <button class="key">h</button>
                <button class="key">j</button>
                <button class="key">k</button>
                <button class="key">l</button>
            </div>
            <div class="keyboard-row">
                <button class="key shift">Shift</button>
                <button class="key">z</button>
                <button class="key">x</button>
                <button class="key">c</button>
                <button class="key">v</button>
                <button class="key">b</button>
                <button class="key">n</button>
                <button class="key">m</button>
                <button class="key backspace"><i class="fas fa-backspace"></i></button>
            </div>
            <div class="keyboard-row">
                <button class="key space">Space</button>
                <button class="key clear">Clear</button>
                <button class="key enter">Enter</button>
            </div>
        </div>
    </div>

    <button id="power-off-button" class="power-off-button mt-6">
        <i class="fas fa-power-off"></i> アプリケーション終了
    </button>

    <!-- 省略: head, bodyタグはそのまま -->

    <script>
        let activeInput = null;
        let shiftMode = false;

        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const alertMessage = document.getElementById('alert-message');
        const alertText = document.getElementById('alert-text');

        usernameInput.addEventListener('focus', () => activeInput = usernameInput);
        passwordInput.addEventListener('focus', () => activeInput = passwordInput);

        // ===== Electron APIモック =====
        if (!window.electronAPI) {
            window.electronAPI = {
                authenticateUser: async (username, password) => {
                    if (username === 'master' && password === '1111') {
                        return { success: true };
                    } else {
                        return { success: false, message: 'IDまたはパスワードが間違っています。' };
                    }
                },
                navigateTo: (page) => {
                    const map = {
                        index: 'index.html',
                        login: 'login.html'
                    };
                    location.href = map[page] || 'index.html';
                },
                quitApp: () => {
                    alert('アプリを終了（モック）');
                }
            };
        }
        window.onload = () => {
            // 履歴スタックを無効化する（戻る・進む無効化）
            history.pushState(null, null, location.href);
            window.onpopstate = () => {
                history.go(1); // 戻る操作をキャンセル
            };
        };

        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                // bfcacheから復帰した時、一度だけリロードする
                window.location.reload();
            }
        });

        // バーチャルキーボードのクリック処理
        document.querySelectorAll('.key').forEach(key => {
            key.addEventListener('click', () => {
                if (!activeInput) return;
                const val = key.innerText.trim();

                if (key.classList.contains('shift')) {
                    shiftMode = !shiftMode;
                    key.classList.toggle('bg-yellow-300');
                } else if (key.classList.contains('space')) {
                    activeInput.value += ' ';
                } else if (key.classList.contains('clear')) {
                    activeInput.value = '';
                } else if (key.classList.contains('backspace')) {
                    activeInput.value = activeInput.value.slice(0, -1);
                } else if (key.classList.contains('enter')) {
                    login();
                } else {
                    activeInput.value += shiftMode ? val.toUpperCase() : val;
                    shiftMode = false;
                    document.querySelector('.shift').classList.remove('bg-yellow-300');
                }
            });
        });

        // ログイン処理
        async function login() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showAlert('IDとパスワードを入力してください。');
                return;
            }

            try {
                const result = await window.electronAPI.authenticateUser(username, password);
                if (result.success) {
                    window.electronAPI.navigateTo('index');
                } else {
                    showAlert(result.message || 'ログインに失敗しました。');
                }
            } catch (error) {
                console.error(error);
                showAlert('ログイン中にエラーが発生しました。');
            }
        }

        function showAlert(message) {
            alertText.textContent = message;
            alertMessage.classList.remove('hidden');
        }

        // アプリ終了ボタン
        document.getElementById('power-off-button').addEventListener('click', () => {
            window.electronAPI.quitApp();
        });

        // Enterキーでもログイン
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>
